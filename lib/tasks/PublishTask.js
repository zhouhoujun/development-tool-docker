"use strict";var __decorate=this&&this.__decorate||function(e,r,t,o){var n,s=arguments.length,i=s<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,r,t,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(i=(s<3?n(i):s>3?n(r,t,i):n(r,t))||i);return s>3&&i&&Object.defineProperty(r,t,i),i};Object.defineProperty(exports,"__esModule",{value:!0});var _=require("lodash"),development_core_1=require("development-core"),NodeDynamicTasks=function(){function e(){this.publishImages=[]}return e.prototype.getServiceInfo=function(e){if(!this._info){var r=e.option,t=e.toSrc(r.images);this._info={images:_.isArray(t)?t:[t],service:e.env.publish||e.toStr(r.service),user:e.env.user||e.toStr(r.user),psw:e.env.psw||e.toStr(r.psw)}}return this._info},e.prototype.tasks=function(){var e=this;return[{name:"build-docker",oper:development_core_1.Operation.deploy,shell:function(e){var r="",t=e.toUrl(e.getRootPath());return/^[C-Z]:/.test(t)&&(r=_.first(t.split(":"))+": & "),r=r+"cd "+t+" & docker-compose build"}},{name:"tag-docker",oper:development_core_1.Operation.deploy,shell:function(r){var t=e.getServiceInfo(r),o="";return _.each(t.images,function(r){var n=t.service+"/"+r;e.publishImages.push(n),o=o+"docker tag "+r+" "+n+" & "}),o=o.substring(0,o.lastIndexOf("&"))}},{name:"push-docker",oper:development_core_1.Operation.deploy,shell:function(r){var t=e.getServiceInfo(r);return _.map(e.publishImages,function(e){return t.user?"docker login -u "+t.user+" -p "+t.psw+" "+t.service+" & docker push "+e:"docker push "+e})}}]},e}();NodeDynamicTasks=__decorate([development_core_1.dynamicTask],NodeDynamicTasks),exports.NodeDynamicTasks=NodeDynamicTasks;
//# sourceMappingURL=../sourcemaps/tasks/PublishTask.js.map
